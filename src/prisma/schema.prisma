datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

generator client {
  provider = "prisma-client-js"
}

generator zod {
  provider                         = "zod-prisma-types"
  output                           = "../model/schema"
  useMultipleFiles                 = false // default is false
  createInputTypes                 = false // default is true
  createModelTypes                 = true // default is true
  addInputTypeValidation           = true // default is true
  addIncludeType                   = false // default is true
  addSelectType                    = false // default is true
  validateWhereUniqueInput         = false // default is false
  createOptionalDefaultValuesTypes = true // default is false
  createRelationValuesTypes        = false // default is false
  createPartialTypes               = true // default is false
  useDefaultValidators             = true // default is true
  coerceDate                       = true // default is true
  writeNullishInModelTypes         = true // default is false
}

generator dbml {
  provider              = "prisma-dbml-generator"
  output                = "./"
  outputName            = "schema.dbml"
  projectName           = "FyTy Core Database"
  includeRelationFields = false
}

// enums
enum Lang {
  TH
  EN
}

enum RoomStatus {
  AVAILABLE
  UNAVAILABLE
  CONFIRMED
  FULL
}

enum MemberRole {
  HEAD_COACH
  LEADER
  MANAGER
  MEMBER
}

enum TrainingStatus {
  // the training partner accepts the result
  ACCEPTED
  // the training partner refuses the result
  DENIED
  // halted by admin (via report)
  INEFFECTIVE
  // the training partner  is not review
  UNREVIEWED
}

enum PendingStatus {
  INCOMING
  OUTGOING
}

enum AdminRole {
  MANAGEMENT
}

// game
model Game {
  id        String  @id
  name      String  @unique
  teamCap   Int
  lineupCap Int
  logoUrl   String
  coverUrl  String
  isActive  Boolean @default(true)
  desc      String  @default("")

  teams       Team[]
  rooms       Room[]
  userAvatars UserAvatar[]
  reviews     Review[]
}

// room
model Room {
  id         String     @id @default(cuid())
  name       String
  status     RoomStatus @default(AVAILABLE)
  option     String     @default("")
  startAt    DateTime
  endAt      DateTime
  isPrivate  Boolean    @default(false)
  teamCount  Int        @default(1)
  note       String     @default("")
  game       Game       @relation(fields: [gameId], references: [id], onUpdate: Cascade)
  gameId     String
  hostTeam   Team       @relation(fields: [hostTeamId], references: [id], onUpdate: Cascade)
  hostTeamId String
  updatedAt  DateTime   @updatedAt
  createdAt  DateTime   @default(now())

  pendings    RoomPending[]
  members     RoomMember[]
  chat        Chat?
  appointment Appointment?
  lineups     RoomLineup[]
  settings    RoomSettings?
}

model RoomSettings {
  id     String @id @default(cuid())
  room   Room   @relation(fields: [roomId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  roomId String @unique
}

model RoomMember {
  id       String   @id @default(cuid())
  team     Team     @relation(fields: [teamId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  teamId   String
  room     Room     @relation(fields: [roomId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  roomId   String
  joinedAt DateTime @default(now())

  roomLineups RoomLineup[]

  @@unique([teamId, roomId])
}

model RoomLineup {
  id           String     @id @default(cuid())
  teamLineup   TeamLineup @relation(fields: [teamLineupId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  teamLineupId String
  roomMember   RoomMember @relation(fields: [roomMemberId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  roomMemberId String
  room         Room       @relation(fields: [roomId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  roomId       String

  @@unique([teamLineupId, roomMemberId, roomId])
}

model RoomPending {
  id        String        @id @default(cuid())
  team      Team          @relation(fields: [teamId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  teamId    String
  room      Room          @relation(fields: [roomId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  roomId    String
  status    PendingStatus @default(INCOMING)
  createdAt DateTime      @default(now())

  lineups RoomPendingLineup[]

  @@unique([teamId, roomId])
}

model RoomPendingLineup {
  id            String      @id @default(cuid())
  roomPending   RoomPending @relation(fields: [roomPendingId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  roomPendingId String
  teamLineup    TeamLineup  @relation(fields: [teamLineupId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  teamLineupId  String

  @@unique([roomPendingId, teamLineupId])
}

// team
model Team {
  id        String   @id @default(cuid())
  name      String
  coverUrl  String   @default("")
  logoUrl   String   @default("")
  tier      String   @default("")
  isPrivate Boolean  @default(false)
  game      Game     @relation(fields: [gameId], references: [id], onUpdate: Cascade)
  gameId    String
  founder   User?    @relation(fields: [founderId], references: [id], onUpdate: Cascade, onDelete: SetNull)
  founderId String?
  isDeleted Boolean  @default(false)
  createdAt DateTime @default(now())

  lineups            TeamLineup[]
  pendings           TeamPending[]
  members            TeamMember[]
  roomHosts          Room[]
  roomPendings       RoomPending[]
  roomMembers        RoomMember[]
  messages           Message[]
  appointmentMembers AppointmentMember[]
  trainingHosts      Training[]          @relation("host")
  trainingGuests     Training[]          @relation("guest")
  stats              TeamStats?
  settings           TeamSettings?
  trainingReports    TrainingReport[]
}

model TeamSettings {
  id               String  @id @default(cuid())
  team             Team    @relation(fields: [teamId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  teamId           String  @unique
  isJoiningEnabled Boolean @default(true)
}

model TeamMember {
  id       String     @id @default(cuid())
  role     MemberRole @default(MEMBER)
  team     Team       @relation(fields: [teamId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  teamId   String
  user     User       @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  userId   String
  joinedAt DateTime   @default(now())
}

model TeamLineup {
  id         String      @id @default(cuid())
  team       Team        @relation(fields: [teamId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  teamId     String
  avatar     UserAvatar? @relation(fields: [avatarId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  avatarId   String?
  inGameId   String?
  isDefault  Boolean     @default(false)
  profileUrl String      @default("")
  imageUrl   String      @default("")
  name       String      @default("new player")
  note       String      @default("")

  roomLineups        RoomLineup[]
  roomPendingLineups RoomPendingLineup[]
}

model TeamPending {
  id        String        @id @default(cuid())
  team      Team          @relation(fields: [teamId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  teamId    String
  user      User          @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  userId    String
  status    PendingStatus @default(INCOMING)
  createdAt DateTime      @default(now())

  @@unique([teamId, userId])
}

// user
model User {
  id                   String    @id @default(cuid())
  username             String    @unique
  updatedUsernameAt    DateTime?
  mobilePhone          String    @unique
  updatedMobilePhoneAt DateTime?
  password             String
  displayName          String
  /// @zod.string.email()
  email                String?   @unique
  updatedEmailAt       DateTime?
  bio                  String    @default("")
  portraitUrl          String    @default("")
  coverUrl             String    @default("")
  isVerified           Boolean   @default(false)
  isDeactivated        Boolean   @default(false)
  facebookId           String?   @unique
  googleId             String?   @unique
  lineId               String?   @unique
  lineToken            String?   @unique
  firstLoginAt         DateTime?
  lastLoginAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  teamFounders         Team[]
  teamPendings         TeamPending[]
  teamMembers          TeamMember[]
  avatars              UserAvatar[]
  reviewers            Review[]              @relation("reviewer")
  reviewees            Review[]              @relation("reviewee")
  messages             Message[]
  settings             UserSettings?
  passwordResetSession PasswordResetSession?
  trainingReports      TrainingReport[]
}

model UserSettings {
  id                             String  @id @default(cuid())
  user                           User    @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  userId                         String  @unique
  isNotifiedBeforeTrainingMinute Int     @default(60)
  isTeamNotified                 Boolean @default(true)
  isMeNotified                   Boolean @default(true)
  isRoomNotified                 Boolean @default(true)
  lang                           Lang    @default(TH)
}

model PasswordResetSession {
  id           String   @id @default(cuid())
  user         User     @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  userId       String   @unique
  token        String   @unique
  attemptCount Int      @default(0)
  expiredAt    DateTime
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())
}

model UserAvatar {
  id            String  @id @default(cuid())
  inGameId      String
  characterName String  @default("")
  rank          String
  ratingScore   Decimal @default(0.0)
  game          Game    @relation(fields: [gameId], references: [id], onUpdate: Cascade)
  gameId        String
  user          User    @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  userId        String

  teamLineups TeamLineup[]
}

model Review {
  id          String   @id @default(cuid())
  content     String
  ratingScore Decimal  @default(0.0)
  reviewer    User?    @relation(fields: [reviewerId], references: [id], onUpdate: Cascade, onDelete: SetNull, name: "reviewer")
  reviewerId  String?
  reviewee    User     @relation(fields: [revieweeId], references: [id], onUpdate: Cascade, onDelete: Cascade, name: "reviewee")
  revieweeId  String
  game        Game     @relation(fields: [gameId], references: [id], onUpdate: Cascade)
  gameId      String
  createdAt   DateTime @default(now())
}

// appointment
model Appointment {
  id              String    @id @default(cuid())
  startAt         DateTime
  endAt           DateTime
  deletedBeforeAt DateTime?
  isDeleted       Boolean   @default(false)
  room            Room?     @relation(fields: [roomId], references: [id], onUpdate: Cascade, onDelete: SetNull)
  roomId          String?   @unique
  createdAt       DateTime  @default(now())

  members  AppointmentMember[]
  training Training?
}

model AppointmentMember {
  id            String      @id @default(cuid())
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  appointmentId String
  team          Team        @relation(fields: [teamId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  teamId        String
  isLeft        Boolean     @default(false)
  createdAt     DateTime    @default(now())

  @@unique([appointmentId, teamId])
}

// chat
model Chat {
  id     String @id @default(cuid())
  room   Room   @relation(fields: [roomId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  roomId String @unique

  messages Message[]
}

model Message {
  id        String   @id @default(cuid())
  chat      Chat     @relation(fields: [chatId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  chatId    String
  reply     Message? @relation(fields: [replyId], references: [id], onUpdate: Cascade, onDelete: Cascade, name: "reply")
  replyId   String?
  imageUrls String[] @default([])
  team      Team?    @relation(fields: [teamId], references: [id], onUpdate: Cascade, onDelete: SetNull)
  teamId    String?
  sender    User?    @relation(fields: [senderId], references: [id], onUpdate: Cascade, onDelete: SetNull)
  senderId  String?
  message   String
  createdAt DateTime @default(now())

  repliedMessages Message[] @relation("reply")
}

// stats
model TeamStats {
  id                     String   @id @default(cuid())
  team                   Team     @relation(fields: [teamId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  teamId                 String   @unique
  leftWhileTrainingCount Int      @default(0)
  completedTrainingCount Int      @default(0)
  trainingMinute         Int      @default(0)
  trainingCount          Int      @default(0)
  winCount               Int      @default(0)
  loseCount              Int      @default(0)
  tieCount               Int      @default(0)
  perGameWinCount        Int      @default(0)
  perGameLoseCount       Int      @default(0)
  updateAt               DateTime @updatedAt
}

// FIXME: the table is support only 2-team games
model Training {
  id            String         @id @default(cuid())
  appointment   Appointment    @relation(fields: [appointmentId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  appointmentId String         @unique
  host          Team?          @relation(fields: [hostId], references: [id], onUpdate: Cascade, onDelete: SetNull, name: "host")
  hostId        String?
  guest         Team?          @relation(fields: [guestId], references: [id], onUpdate: Cascade, onDelete: SetNull, name: "guest")
  guestId       String?
  hostWinCount  Int?
  hostLoseCount Int?
  note          String         @default("")
  status        TrainingStatus @default(UNREVIEWED)
  imageUrls     String[]       @default([])
  isSubmitted   Boolean        @default(false)
  updatedAt     DateTime       @updatedAt
  createdAt     DateTime       @default(now())

  reports TrainingReport[]
}

model TrainingReport {
  id              String   @id @default(cuid())
  reporterUser    User?    @relation(fields: [reporterUserId], references: [id], onUpdate: Cascade, onDelete: SetNull)
  reporterUserId  String?
  reporterTeam    Team?    @relation(fields: [reporterTeamId], references: [id], onUpdate: Cascade, onDelete: SetNull)
  reporterTeamId  String?
  training        Training @relation(fields: [trainingId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  trainingId      String
  isAdminReviewed Boolean  @default(false)
  heading         String
  content         String
  imageUrls       String[] @default([])
  createdAt       DateTime @default(now())
}

// admin
model Admin {
  id        String    @id @default(cuid())
  /// @zod.string.email()
  email     String    @unique
  password  String
  role      AdminRole @default(MANAGEMENT)
  createdAt DateTime  @default(now())
  updateAt  DateTime  @updatedAt
}
